{
  "env": {
    "CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS": "1",
    "CLAUDE_CODE_ENABLE_TELEMETRY": "1",
    "ENABLE_TOOL_SEARCH": "auto:5",
    "OTEL_METRICS_EXPORTER": "otlp",
    "OTEL_LOGS_EXPORTER": "otlp",
    "OTEL_EXPORTER_OTLP_PROTOCOL": "grpc",
    "OTEL_EXPORTER_OTLP_ENDPOINT": "http://localhost:4317"
  },
  "permissions": {
    "allow": [
      "Bash(uv sync:*)",
      "Bash(uv run pytest:*)",
      "Bash(uv run python:*)",
      "Bash(uv run ruff:*)",
      "Bash(uv run mypy:*)",
      "Bash(docker compose:*)",
      "Bash(bd:*)",
      "Bash(git status:*)",
      "Bash(git diff:*)",
      "Bash(git log:*)",
      "Bash(git show:*)",
      "Bash(git branch:*)",
      "Bash(just:*)",
      "Bash(uv add:*)",
      "Bash(uv remove:*)",
      "Bash(git add:*)",
      "Bash(git commit:*)",
      "Bash(git push:*)",
      "Bash(git mv:*)",
      "Bash(git checkout:*)",
      "Bash(tree:*)"
    ],
    "defaultMode": "default"
  },
  "hooks": {
    "SessionStart": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "echo '=== Session Start ==='; git log --oneline -3 2>/dev/null | sed 's/^/Last:    /'; git diff --stat --cached 2>/dev/null; echo \"Tree:    $(git status --short 2>/dev/null | wc -l) uncommitted files\"; bd stats --oneline 2>/dev/null || true; bd ready --count 2>/dev/null | sed 's/^/Ready:   /' || true; bd list --status=in_progress --count 2>/dev/null | sed 's/^/Active:  /' || true; bd prime 2>/dev/null || true; echo '=== ==='"
          },
          {
            "type": "command",
            "command": "bash bin/rule-relevance.sh 2>/dev/null || true"
          }
        ]
      }
    ],
    "PreCompact": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "bd sync --flush-only 2>/dev/null || true; mkdir -p memory/sessions && { NOW=$(date -u +%Y-%m-%dT%H:%M:%SZ); printf '## Pre-Compact Snapshot\\n**Time**: %s\\n\\n### In-Progress Tasks\\n' \"$NOW\"; bd list --status=in_progress 2>/dev/null || echo '(beads unavailable)'; printf '\\n### Recent Commits\\n'; git log --oneline -5 2>/dev/null || echo '(no git)'; printf '\\n### Working Tree\\n'; git status --short 2>/dev/null || echo '(no git)'; printf '\\n### Open Questions\\n(fill in before context is lost)\\n\\n### Working Theories\\n(fill in before context is lost)\\n\\n### Key Decisions\\n(fill in before context is lost)\\n'; } > memory/sessions/pre-compact.md 2>/dev/null || true"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "if echo \"$CLAUDE_TOOL_INPUT\" | grep -qE '\"git push' 2>/dev/null; then if [ -d .beads ]; then STATUS=$(bd sync --status 2>/dev/null); if echo \"$STATUS\" | grep -qiE 'uncommitted|dirty|pending'; then echo 'BEADS WARNING: Uncommitted beads changes detected. Run bd sync before pushing.' >&2; fi; fi; fi"
          }
        ]
      },
      {
        "matcher": "Bash",
        "hooks": [
          {
            "type": "command",
            "command": "INPUT=\"$CLAUDE_TOOL_INPUT\"; if echo \"$INPUT\" | grep -qE '\"git reset --hard' 2>/dev/null; then echo 'DESTRUCTIVE WARNING: git reset --hard will discard all uncommitted changes. This is irreversible.' >&2; elif echo \"$INPUT\" | grep -qE '\"git checkout \\.' 2>/dev/null; then echo 'DESTRUCTIVE WARNING: git checkout . will discard all unstaged changes. This is irreversible.' >&2; elif echo \"$INPUT\" | grep -qE '\"git clean -f' 2>/dev/null; then echo 'DESTRUCTIVE WARNING: git clean -f will permanently delete untracked files.' >&2; elif echo \"$INPUT\" | grep -qE '\"rm -rf [^\"]*[^/.]' 2>/dev/null; then echo 'DESTRUCTIVE WARNING: rm -rf detected on a non-trivial path. Verify the target before proceeding.' >&2; elif echo \"$INPUT\" | grep -qE '\\.beads/' 2>/dev/null && echo \"$INPUT\" | grep -qvE '\"bd ' 2>/dev/null; then echo 'DESTRUCTIVE WARNING: Direct .beads/ file operation detected. Use bd commands instead of modifying .beads/ internals directly.' >&2; fi"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Task",
        "hooks": [
          {
            "type": "command",
            "command": "echo 'REVIEW GATE: Agent completed. Verify deliverable quality before proceeding:' >&2; echo '  [ ] Spike sections present: Firm Tasks Found | Areas Needing Deeper Spikes | Clean Areas | Summary' >&2; echo '  [ ] Findings tagged with confidence: CONFIRMED | LIKELY | POSSIBLE' >&2; echo '  [ ] Evidence includes file paths and line numbers' >&2; echo '  [ ] Gaps captured as new beads | Downstream connections identified' >&2"
          }
        ]
      },
      {
        "matcher": "Skill",
        "hooks": [
          {
            "type": "command",
            "command": "mkdir -p ~/.claude/telemetry && echo \"{\\\"ts\\\":\\\"$(date -Is)\\\",\\\"skill\\\":\\\"$(echo \"$CLAUDE_TOOL_INPUT\" | head -c 200)\\\",\\\"project\\\":\\\"$(pwd)\\\"}\" >> ~/.claude/telemetry/skills.jsonl || true"
          }
        ]
      }
    ],
    "UserPromptSubmit": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "python3 -c \"\nimport os, json, sys, re\ndomain = 'memory/project/domain.md'\nif not os.path.exists(domain): sys.exit(0)\ntry:\n    inp = json.loads(os.environ.get('CLAUDE_TOOL_INPUT', '{}'))\n    prompt = inp.get('prompt', '')\nexcept Exception: sys.exit(0)\nif not prompt: sys.exit(0)\ntext = open(domain).read()\nblocks = re.split(r'(?=^## )', text, flags=re.MULTILINE)\nmatched = [b for b in blocks if b.startswith('## ') and re.search(r'## (.+)', b) and re.search(re.escape(re.search(r'## (.+)', b).group(1)), prompt, re.IGNORECASE)]\nif not matched: sys.exit(0)\nprint('<!-- domain-context -->')\nfor b in matched:\n    print(b.strip())\n    print()\n\" 2>/dev/null || true"
          }
        ]
      }
    ],
    "SessionEnd": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "mkdir -p memory/sessions && NOW=$(date -u '+%Y-%m-%dT%H-%M-%SZ') && FILE=\"memory/sessions/${NOW}.md\" && echo \"## Session: $NOW\" > \"$FILE\" && echo '' >> \"$FILE\" && echo '### Commits' >> \"$FILE\" && COMMITS=$(git log --oneline -10 2>/dev/null); if [ -n \"$COMMITS\" ]; then echo \"$COMMITS\" >> \"$FILE\"; else echo '(none)' >> \"$FILE\"; fi && echo '' >> \"$FILE\" && echo '### Working Tree' >> \"$FILE\" && TREE=$(git status --short 2>/dev/null); if [ -n \"$TREE\" ]; then echo \"$TREE\" >> \"$FILE\"; else echo 'clean' >> \"$FILE\"; fi && echo '' >> \"$FILE\" && echo '### Backlog' >> \"$FILE\" && BACKLOG=$(bd stats --oneline 2>/dev/null || bd stats 2>/dev/null); if [ -n \"$BACKLOG\" ]; then echo \"$BACKLOG\" >> \"$FILE\"; else echo '(beads unavailable)' >> \"$FILE\"; fi && echo '' >> \"$FILE\" && echo '### In Progress' >> \"$FILE\" && INPROG=$(bd list --status=in_progress 2>/dev/null); if [ -n \"$INPROG\" ]; then echo \"$INPROG\" >> \"$FILE\"; else echo '(none)' >> \"$FILE\"; fi && cp \"$FILE\" memory/sessions/last.md 2>/dev/null || true && ls -t memory/sessions/[0-9]*.md 2>/dev/null | tail -n +4 | xargs rm -f 2>/dev/null || true; bd sync --flush-only 2>/dev/null || true"
          }
        ]
      }
    ]
  },
  "skipDangerousModePermissionPrompt": true,
  "effortLevel": "medium"
}
