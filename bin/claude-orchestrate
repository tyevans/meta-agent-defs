#!/usr/bin/env bash
# claude-orchestrate: Launch Claude Code as an orchestrator that dispatches
# work via claude-in-claude (CLI subprocesses) instead of built-in Task agents.
#
# This ensures each subprocess picks up the latest MEMORY.md, learnings,
# and project context dynamically rather than inheriting a frozen snapshot.

set -euo pipefail

# Resolve through symlinks to find the actual repo root
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
    DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
done
REPO_DIR="$(cd "$(dirname "$SOURCE")/.." && pwd)"
PROMPT_FILE="$REPO_DIR/prompts/orchestrate-system.md"

if [ ! -f "$PROMPT_FILE" ]; then
    echo "ERROR: Missing system prompt at $PROMPT_FILE" >&2
    exit 1
fi

SYSTEM_PROMPT="$(cat "$PROMPT_FILE")"

exec claude \
    --permission-mode bypassPermissions \
    --append-system-prompt "$SYSTEM_PROMPT" \
    "$@"
